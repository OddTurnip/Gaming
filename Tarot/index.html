<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tarot Reading</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="../favicon.ico" type="image/x-icon">
    <!-- Apply theme immediately to prevent flash of unstyled content -->
    <script src="../Themes/theme-init.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-row">
                <!-- Left: Navigation -->
                <div class="header-nav">
                    <a href="../index.html" class="nav-button">‚Üê Home</a>
                </div>

                <!-- Center: Title -->
                <div class="header-title">
                    <h1>Tarot Reading</h1>
                </div>

                <!-- Right: Theme selector -->
                <div class="header-theme" id="theme-slot"></div>
            </div>
        </div>

        <div class="controls">
			<button id="newReadingButton" class="roll-button">New Reading</button>

            <div class="control-group">
                <div class="control-group-inline">
					<label>Deck Type:</label>
                    <label class="radio-label">
                        <input type="radio" name="deckType" value="both" checked>
                        Both
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="deckType" value="major">
                        Major Arcana
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="deckType" value="minor">
                        Minor Arcana
                    </label>
                </div>
            </div>

            <div class="control-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="includeReversed" checked>
                    Include Reversed Cards
                </label>
            </div>
        </div>

        <div class="cards-container">
            <div class="card-position">
                <div class="card-label">Past</div>
                <div id="pastCard" class="card-display">--</div>
            </div>
            <div class="card-position">
                <div class="card-label">Present</div>
                <div id="presentCard" class="card-display">--</div>
            </div>
            <div class="card-position">
                <div class="card-label">Future</div>
                <div id="futureCard" class="card-display">--</div>
            </div>
        </div>

        <div class="history-section">
            <h2>Reading History</h2>
            <div id="readingHistory" class="roll-history"></div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <a href="https://www.oddturnip.com" target="_blank" rel="noopener noreferrer" class="oddturnip-link">
                <img src="../Names/odd_turnip.png" alt="OddTurnip Logo">
                <span>OddTurnip.com</span>
            </a>
        </div>
    </div>

    <!-- Card Description Modal -->
    <div id="cardModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" id="modalClose">&times;</button>
            <img id="modalCardImage" class="modal-card-image" src="" alt="">
            <div class="modal-card-name" id="modalCardName"></div>
            <div class="modal-card-orientation" id="modalCardOrientation"></div>
            <div class="modal-card-meaning" id="modalCardMeaning"></div>
        </div>
    </div>

    <script type="module">
        // Import Tarot reading logic and history utilities
        import { performThreeCardSpread, formatTarotCard, getCardImagePath, getCardMeaning } from './tarot.js';
        import { createComplexHistoryEntry, addToHistory } from '../Dice/history-log.js';
        import {
            createThemeSelector,
            getAnimationsEnabled,
            setAnimationsEnabled
        } from '../Themes/theme-manager.js';
        import { createSeasonalEffects } from '../Themes/snowflakes.js';

        // Make createSeasonalEffects available globally for the animated checkbox
        window.createSeasonalEffects = createSeasonalEffects;

        // Add theme selector to the page
        const slot = document.getElementById('theme-slot');
        if (slot) {
            const wrapper = document.createElement('div');
            wrapper.className = 'theme-selector-wrapper';
            wrapper.style.flexDirection = 'column';
            wrapper.style.alignItems = 'flex-end';

            const topRow = document.createElement('div');
            topRow.style.display = 'flex';
            topRow.style.alignItems = 'center';
            topRow.style.gap = '8px';

            const label = document.createElement('label');
            label.textContent = 'Theme:';
            label.htmlFor = 'theme-selector';

            topRow.appendChild(label);
            topRow.appendChild(createThemeSelector());
            wrapper.appendChild(topRow);

            const bottomRow = document.createElement('div');
            bottomRow.style.display = 'flex';
            bottomRow.style.alignItems = 'center';
            bottomRow.style.justifyContent = 'flex-end';
            bottomRow.style.marginTop = '6px';
            bottomRow.style.gap = '5px';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = 'animated-checkbox';
            checkbox.checked = getAnimationsEnabled();

            const checkboxLabel = document.createElement('label');
            checkboxLabel.htmlFor = 'animated-checkbox';
            checkboxLabel.textContent = 'Animated';
            checkboxLabel.style.cursor = 'pointer';

            checkbox.addEventListener('change', (e) => {
                setAnimationsEnabled(e.target.checked);
                if (window.createSeasonalEffects) {
                    window.createSeasonalEffects();
                }
            });

            bottomRow.appendChild(checkbox);
            bottomRow.appendChild(checkboxLabel);
            wrapper.appendChild(bottomRow);

            slot.appendChild(wrapper);
        }

        // State management
        let handCounter = 0;
        let currentCards = {
            past: null,
            present: null,
            future: null
        };

        // Event listeners
        document.getElementById('newReadingButton').addEventListener('click', performReading);

        // Card click handlers
        document.getElementById('pastCard').addEventListener('click', function() {
            openCardModal(currentCards.past, 'past');
        });

        document.getElementById('presentCard').addEventListener('click', function() {
            openCardModal(currentCards.present, 'present');
        });

        document.getElementById('futureCard').addEventListener('click', function() {
            openCardModal(currentCards.future, 'future');
        });

        // Modal close handlers
        document.getElementById('modalClose').addEventListener('click', closeCardModal);

        document.getElementById('cardModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeCardModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeCardModal();
            }
        });

        // Perform initial reading on page load
        performReading();

        /**
         * Perform a new tarot reading
         */
        function performReading() {
            // Get selected deck type
            const deckType = getSelectedDeckType();
            const includeReversed = document.getElementById('includeReversed').checked;

            // Perform three-card spread using pure function
            const spread = performThreeCardSpread(deckType, includeReversed);

            // Store current cards
            currentCards.past = spread.past;
            currentCards.present = spread.present;
            currentCards.future = spread.future;

            // Update display
            updateCardDisplay('pastCard', spread.past);
            updateCardDisplay('presentCard', spread.present);
            updateCardDisplay('futureCard', spread.future);

            // Add to history
            handCounter++;
            addReadingToHistory(handCounter, spread.past, spread.present, spread.future);
        }

        /**
         * Get selected deck type from radio buttons
         */
        function getSelectedDeckType() {
            const radios = document.getElementsByName('deckType');
            for (const radio of radios) {
                if (radio.checked) {
                    return radio.value;
                }
            }
            return 'major';
        }

        /**
         * Update card display in the UI
         */
        function updateCardDisplay(elementId, card) {
            const element = document.getElementById(elementId);
            if (card) {
                element.innerHTML = '';

                const img = document.createElement('img');
                img.src = getCardImagePath(card);
                img.alt = formatTarotCard(card);
                img.className = 'card-image';
                if (card.isReversed) {
                    img.classList.add('reversed');
                }

                const text = document.createElement('div');
                text.className = 'card-name';
                text.textContent = formatTarotCard(card);

                element.appendChild(img);
                element.appendChild(text);
            } else {
                element.textContent = '--';
            }
        }

        /**
         * Add reading to history
         */
        function addReadingToHistory(handNumber, pastCard, presentCard, futureCard) {
            const historyContainer = document.getElementById('readingHistory');

            // Create complex history entry HTML
            const content = `
                <div class="history-hand-title">Hand ${handNumber}</div>
                <ul>
                    <li>${formatTarotCard(pastCard)}</li>
                    <li>${formatTarotCard(presentCard)}</li>
                    <li>${formatTarotCard(futureCard)}</li>
                </ul>
            `;

            const entry = createComplexHistoryEntry(content, 'history-hand');
            addToHistory(historyContainer, entry);
        }

        /**
         * Open card detail modal
         */
        function openCardModal(card, position) {
            if (!card) return;

            const modal = document.getElementById('cardModal');
            const cardImage = document.getElementById('modalCardImage');
            const cardName = document.getElementById('modalCardName');
            const cardOrientation = document.getElementById('modalCardOrientation');
            const cardMeaning = document.getElementById('modalCardMeaning');

            // Set card image
            cardImage.src = getCardImagePath(card);
            cardImage.alt = formatTarotCard(card);
            if (card.isReversed) {
                cardImage.classList.add('reversed');
            } else {
                cardImage.classList.remove('reversed');
            }

            // Set card name
            let name = card.type === 'major' ? `${card.number}. ${card.name}` : card.name;
            cardName.textContent = name;

            // Set orientation and meaning
            const meaning = getCardMeaning(card);
            cardOrientation.textContent = meaning.orientation;
            cardMeaning.textContent = meaning.meaning;

            // Show modal
            modal.classList.add('active');
        }

        /**
         * Close card detail modal
         */
        function closeCardModal() {
            const modal = document.getElementById('cardModal');
            modal.classList.remove('active');
        }
    </script>
</body>
</html>
